<!DOCTYPE html>
<html lang="tr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Profil Ayarlarƒ± - Blog Projesi</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body class="bg-light">

        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="index.html">üöÄ Blog Projesi</a>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm">Geri D√∂n</a>
            </div>
        </nav>

        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">‚öôÔ∏è Profil Ayarlarƒ±</h4>
                        </div>
                        <div class="card-body p-4">

                            <div class="text-center mb-4">
                                <img id="preview-image" src="https://cdn-icons-png.flaticon.com/512/149/149071.png"
                                class="rounded-circle border border-3 border-primary"
                                style="width: 120px; height: 120px; object-fit: cover;">
                            </div>

                            <form id="settingsForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Kullanƒ±cƒ± Adƒ±</label>
                                    <input type="text" id="username" class="form-control" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Profil Resmi (URL)</label>
                                    <input type="url" id="profile_image" class="form-control" placeholder="https://ornek.com/resim.jpg">
                                    <div class="form-text">Google'dan bir resim baƒülantƒ±sƒ± yapƒ±≈ütƒ±rabilirsin.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Hakkƒ±mda (Biyografi)</label>
                                    <textarea id="bio" class="form-control" rows="4" placeholder="Kendinden bahset..."></textarea>
                                </div>

                                <div id="message" class="text-center mb-3"></div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary fw-bold">üíæ Deƒüi≈üiklikleri Kaydet</button>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const token = localStorage.getItem('token');
            if (!token) window.location.href = 'login.html';

            document.addEventListener('DOMContentLoaded', async () => {
                const imgPreview = document.getElementById('preview-image');

                try {
                    const res = await fetch('http://localhost:3000/api/users/profile', {
                        headers: { 'Authorization': `Bearer ${token}`}
                    });
                    const user = await res.json();

                    if (res.ok) {
                        document.getElementById('username').value = user.username;
                        document.getElementById('bio').value = user.bio || '';
                        document.getElementById('profile_image').value = user.profile_image || '';

                        if (user.profile_image) {
                            imgPreview.src = user.profile_image;
                        }
                    }
                } catch (error) {
                    console.error('Profil y√ºklenemedi', error);
                }

                document.getElementById('settingsForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const username = document.getElementById('username').value;
                    const bio = document.getElementById('bio').value;
                    const profile_image = document.getElementById('profile_image').value;
                    const messageDiv = document.getElementById('message');

                    try {
                        const res = await fetch('http://localhost:3000/api/users/update', {
                            method: 'PUT' ,
                            headers: {
                                'Content-Type': 'application/json' ,
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ username, bio, profile_image })
                        });

                        const data = await res.json();

                        if (res.ok) {
                            localStorage.setItem('username', username);

                            messageDiv.innerHTML = '<span class="text-success fw-bold">‚úÖ Profil G√ºncellendi!</span>';
                            setTimeout(() => window.location.href = 'dashboard.html', 1500);
                        } else {
                            messageDiv.innerHTML = `<span class="text-danger">${data.message}</span>`;
                        }
                    } catch (error) {
                        messageDiv.innerHTML = '<span class="text-danger">Sunucu hatasƒ±!</span>';
                    }
                });
            });
        </script>
    </body>
</html>